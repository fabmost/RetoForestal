<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Titular de aprovechamiento forestal - Prototipo</title>
    <link rel="stylesheet" href="../css/foundation.css" />
    <script src="../js/vendor/modernizr.js"></script>
	<style>
		/* desde aqui empieza footer y header */
		.row.footer {
		  max-width: 100%;
		  padding: 0.8em;
		  text-align: center;
		  color: #868686;
		  border-top-style: solid;
		  border-top-color: #868686;
		  border-top-width: 1px;
		  margin-top: 4em;
		}
		.row.footer p{	
			line-height: 1;
			margin-bottom: 0.4rem;
		}
		.header {
		  max-width: 100%;
		  max-height: 200px; 
		  margin-bottom:3em; 
		}
		.header .verde {
			background-color:#00a89b;
		}
		.header img {
		  max-height: 140px;
		}
		.header .logo_semarnat_container{
			text-align:center;
			vertical-align:middle;
			width:29.16%;
		}
		.header .logo_forestapp_letras{
			width:70.83%;
		}
		.logo_forestapp_letras .logo{
			  width: 13.3%;
			  padding: 0px;
			  margin: 0.2em 2% 0% 0%;
		}
		.logo_forestapp_letras .letras{
			  width: 55%;
			  padding: 0px;
			  margin-top: 1.5em;
			  margin-left: 16.54%;
			  margin-right: 9.54%;
		}
		.helper {
			display: inline-block;
			height: 100%;
			vertical-align: middle;
		}
		/* hasta aqui llega footer y header */
	</style>
	<style>
		/* para navegación */
		.header{margin-bottom:0px;}
		
		.navegacion {
			margin-bottom: 3em;
			background-color: #89bd2e;
		}
		.item_navegacion{
			  text-align: center;
			  border-left-style: solid;
			  border-color: rgb(215, 239, 214);
			  padding-bottom: 0.5em;
			padding-top: 0.5em;
		}
		.item_navegacion:hover{
			background-color: #1b676c;
		}
		.item_navegacion:first-child{
			border-width:0px;
		}
		.item_navegacion a{
			color:white;
		}
	</style>
  </head>
  <body>
    <div class="row header clearfix" data-equalizer>
	  <div class="left logo_semarnat_container" data-equalizer-watch>
		
		<img class="left " src="../img/Logo_Semarnat_Horizontal.jpg" alt="logo_semarnat"  />
	  </div>
	  <div class="left logo_forestapp_letras verde" data-equalizer-watch>
		  <div class="left letras"  >
			<span class="helper"> </span>
		<img class="left logo_semarnet_letras" src="../img/forestappb.png" alt="logo_forestapp"  />
		  </div>
		  <div class="right logo text-right" >
			<img  src="../img/icono_forestapp.png" alt="logo" />
		  </div>
	  </div>
	</div>
	
	<!-- navegacion -->
	<div class="navegacion">
		<div class="row" data-equalizer>
			  <div class="small-4 columns item_navegacion" data-equalizer-watch>
				<a href="historico.html" title="Ver operaciones realizadas">Hist&oacute;rico</a>
			  </div>
			  <div class="small-4 columns item_navegacion" data-equalizer-watch>
				<a href="index.html" title="Alta de documento">Alta de remisiones y reembarques</a>
			  </div>
			  <div class="small-4 columns item_navegacion" data-equalizer-watch>
				<a href="nuevo_transporte.html" title="Registrar nuevo transportista">Alta transportista</a>
			  </div>
		</div>
	 </div>
	<div class="row">
		  <div class="small-8 small-offset-2 columns">
		<div class="row">
		  <div class="large-12 columns">
			<h1>Alta de nuevo transporte</h1>
		  </div>
		</div>
			
		<div class="row registroUsuario">
		  <div class="large-12 columns">
			<form id="formu"><!--option value="1RhGvNMSrF">Transportista</option-->
				<div class="row comun">
					<div class="large-12 columns">
					  <label>Nombre de usuario:
						<input type="text" id="username" placeholder="Ingresa el nombre de usuario" />
					  </label>
					</div>
				</div>
				<div class="row comun">
					<div class="large-12 columns">
					  <label>Contrase&ntilde;a:
						<input type="password" id="pass" placeholder="Ingresa la contrase&ntilde;a" />
					  </label>
					</div>
				</div>
				<div class="row comun">
					<div class="large-12 columns">
					  <label>Reescribe la contrase&ntilde;a:
						<input type="password" id="pass2" placeholder="Reescribe la contrase&ntilde;a" />
					  </label>
					</div>
				</div>
				
				<div class="transportista rolForm "> <!-- transportista -->
					<label>Medio de transporte:
						<input type="text" id="mediotrans" placeholder="Ingresa el medio de transporte" />
					</label>
					<label>Propietario del transporte:
						<input type="text" id="propietrans" placeholder="Ingresa el propietario de transporte" />
					</label>
					<label>Marca del transporte:
						<input type="text" id="marcatrans"placeholder="Ingresa la marca del transporte" />
					</label>
					<label>Tipo de transporte:
						<input type="text" id="tipotrans" placeholder="Ingresa el tipo de transporte" />
					</label>
					<label>Modelo del transporte:
						<input type="text" id="modelotrans" placeholder="Ingresa el modelo de transporte" />
					</label>
					<label>Capacidad del transporte:
						<input type="text" id="capacidadtrans" placeholder="Ingresa la capacidad del transporte" />
					</label>
					<label>Placas del transporte:
						<input type="text" id="placastrans" placeholder="Ingresa el no. de placa del transporte" />
					</label>
					<label>Nombre del operador del transporte:
						<input type="text" id="operadortrans" placeholder="Ingresa el nombre del operador" />
					</label>
					<input type="hidden" id="idtitular" value="" />
				</div><!-- /transportista -->
				<div class="row comun"> 
					<div class="large-12 columns text-right "> 
						<div id="mensaje_enviar"></div>
						<a href="#" id="enviar" class="button radius">Enviar</a>
						<a href="#" id="borrar" class="button radius">Borrar</a>
					</div>
				</div>
			</form>
		  </div>
		</div>
		</div>
	</div>
	<div class="row footer">
	  <div class="small-12 columns">
		<p>Blvd. Adolfo Ruiz Cortines # 4209 Col. Jardines de la Monta&ntilde;a, Deleg. Tlalpan</p>
		<p>Distrito Federal CP. 14210, Tel. (55) 5490-0900</p>
	  </div>
	  
	</div>
    <script src="../js/vendor/jquery.js"></script>
	<script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.4.0.min.js"></script> 
    <script src="../js/foundation.min.js"></script>
    <script>
		// inicialización de parse y foundation
		$(document).foundation();
		Parse.initialize("xJPG4xeiwqTF0RKZgHboZDTzl2aWn7lDBTM8iZQh", "Jmvrl7iprcqLFyeoptiorcg5ISdlrSTlAOuoIoyF");
		$(document).ready(function(){
			currentUser = Parse.User.current(); // usuario antes de levantar al otro...
			if (currentUser) {
				// do stuff with the user
				console.log("current id: " + currentUser.id);
				// * averiguamos cual es el titular actual
				var Titular = Parse.Object.extend("Titular");
				var query = new Parse.Query(Titular);
				query.equalTo("Usuario", currentUser);
				query.first({
				  success: function(tit) {
					// Successfully retrieved the object.
					$("#idtitular").val(tit.id); // para evitar problemas
				},
				  error: function(error) {
					console.log("Error: " + error.code + " " + error.message);
				  }
				});
			} else {
				// show the signup or login page
				console.log("no login info");
			}
			//Parse.User.logOut();
			//console.log(Parse.User.current());
		});
		// listener de botones
		$("#enviar").click(function(){
			console.log("enviar" );
			guardaObjeto();
		});
		
		$("#borrar").click(function(){
			//console.log("borrar" );
			//console.log($("#formu"));
			$("#formu")[0].reset();
		});

		// llamsr despues de hacer un save o algo a parse para borrar
		// el form e informar y hacer espacio en la consola
		function afterRequest($resultado){
			$("#borrar").click();
			if($resultado == "success"){
				console.log("current.id: " + currentUser.id);
				console.log("Exito **** \n");
				Parse.User.logOut(); // volamos al transportista
				alertSuccess("Se ha registrado al transportista correctamente");
			} else {
				console.log("Algo fallo ****\n ");
				alertError("Ocurri&oacute; un error al registrar al transportista, intente con otro nombre de usuario o contacte a soporte");
			}
		}
		function alertError(msg){
			var espacio = $("#mensaje_enviar");
			// no pasa validacion
			var html = '<div data-alert class="alert-box dos  alert radius">'+
				msg + '<a href="#" class="close">&times;</a></div>';
			//var espacio = $("#mensaje");
			espacio.addClass("hide");
			var html1 = espacio.html();
			espacio.html(html1 + html);
			espacio.show("slow");
			$(document).foundation();
		}
		function alertSuccess(msg){
			var espacio = $("#mensaje_enviar");
			// no pasa validacion
			var html = '<div data-alert class="alert-box dos  success radius">'+
				msg + '<a href="#" class="close">&times;</a></div>';
			//var espacio = $("#mensaje");
			espacio.addClass("hide");
			var html1 = espacio.html();
			espacio.html(html1 + html);
			espacio.show("slow");
			$(document).foundation();
		}
	
		// guarda los datos a parse usuario y de acuerdo a su rol
		function guardaObjeto(){
			var $username = $("#username").val();
			var $pass = $("#pass").val();
			// preparamos rol para relational data
			var Rol = Parse.Object.extend("Rol");
			var $rol = new Rol();
			$rol.id = '1RhGvNMSrF';//******** rol
			// preparamos user para relational data
			var u = new Parse.User();
			u.set("username", $username);
			u.set("password", $pass);
			u.set("Rol", $rol);
			// hacemos la relación al rol
			u.signUp(null, {
			  success: function(u) { // **** usuario creado con éxito
				console.log('User created Id: ' + u.id);
				//case '1RhGvNMSrF': // transp
				var Transportistas = Parse.Object.extend("Transportistas");
				var trans = new Transportistas();
				var Titular = Parse.Object.extend("Titular");
				var titular = new Titular();
				titular.id = $("#idtitular").val()
				trans.save({
					  Capacidad:$("#capacidadtrans").val(),
					  Chofer: $("#operadortrans").val(),
					  Marca:$("#marcatrans").val(),
					  Medio:$("#mediotrans").val(),
					  Modelo:$("#modelotrans").val(),
					  Placas:$("#placastrans").val(),
					  Propietario:$("#propietrans").val(),
					  Tipo:$("#tipotrans").val(),
					  Titular:titular,
					  Usuario: u
					}, {
					  success: function(trans) { // guardado
						console.log("trans guardado");
						afterRequest("success");
					  },
					  error: function(trans, error) { // bailo...
						console.log('Failed to create new trans, with error code: ' + error.message);
						afterRequest("error");
					  }
				});
			  },
			  error: function(u, error) {
				// Execute any logic that should take place if the save fails.
				// error is a Parse.Error with an error code and message.
				console.log('Failed to create new User, with error code: ' + error.message);
				afterRequest("error");
			  }
			});
		}
		 
		  
    </script>
  
  </body>
</html>
