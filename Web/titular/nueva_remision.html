<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Titular de aprovechamiento forestal - Prototipo</title>
    <link rel="stylesheet" href="../css/foundation.css" />
    <script src="../js/vendor/modernizr.js"></script>
			<style>
		/* desde aqui empieza footer y header */
		.row.footer {
		  max-width: 100%;
		  padding: 0.8em;
		  text-align: center;
		  color: #868686;
		  border-top-style: solid;
		  border-top-color: #868686;
		  border-top-width: 1px;
		  margin-top: 4em;
		}
		.row.footer p{	
			line-height: 1;
			margin-bottom: 0.4rem;
		}
		.header {
		  max-width: 100%;
		  max-height: 200px; 
		  margin-bottom:3em; 
		}
		.header .verde {
			background-color:#00a89b;
		}
		.header img {
		  max-height: 140px;
		}
		.header .logo_semarnat_container{
			text-align:center;
			vertical-align:middle;
			width:29.16%;
		}
		.header .logo_forestapp_letras{
			width:70.83%;
		}
		.logo_forestapp_letras .logo{
			  width: 13.3%;
			  padding: 0px;
			  margin: 0.2em 2% 0% 0%;
		}
		.logo_forestapp_letras .letras{
			  width: 55%;
			  padding: 0px;
			  margin-top: 1.5em;
			  margin-left: 16.54%;
			  margin-right: 9.54%;
		}
		.helper {
			display: inline-block;
			height: 100%;
			vertical-align: middle;
		}
		/* hasta aqui llega footer y header */
	</style>
	<style>
		/* para navegación */
		.header{margin-bottom:0px;}
		
		.navegacion {
			margin-bottom: 3em;
			background-color: #89bd2e;
		}
		.item_navegacion{
			  text-align: center;
			  border-left-style: solid;
			  border-color: rgb(215, 239, 214);
			  padding-bottom: 0.5em;
			padding-top: 0.5em;
		}
		.item_navegacion:hover{
			background-color: #1b676c;
		}
		.item_navegacion:first-child{
			border-width:0px;
		}
		.item_navegacion a{
			color:white;
		}
	</style>
  </head>
  <body>
    <div class="row header clearfix" data-equalizer>
	  <div class="left logo_semarnat_container" data-equalizer-watch>
		
		<img class="left " src="../img/Logo_Semarnat_Horizontal.jpg" alt="logo_semarnat"  />
	  </div>
	  <div class="left logo_forestapp_letras verde" data-equalizer-watch>
		  <div class="left letras"  >
			<span class="helper"> </span>
		<img class="left logo_semarnet_letras" src="../img/forestappb.png" alt="logo_forestapp"  />
		  </div>
		  <div class="right logo text-right" >
			<img  src="../img/icono_forestapp.png" alt="logo" />
		  </div>
	  </div>
	</div>
	
	<!-- navegacion -->
	<div class="navegacion">
		<div class="row" data-equalizer>
			  <div class="small-4 columns item_navegacion" data-equalizer-watch>
				<a href="historico.html" title="Ver operaciones realizadas">Hist&oacute;rico</a>
			  </div>
			  <div class="small-4 columns item_navegacion" data-equalizer-watch>
				<a href="index.html" title="Alta de documento">Alta de remisiones y reembarques</a>
			  </div>
			  <div class="small-4 columns item_navegacion" data-equalizer-watch>
				<a href="nuevo_transporte.html" title="Registrar nuevo transportista">Alta transportista</a>
			  </div>
		</div>
	 </div>
	 <div class="row">
		  <div class="small-8 small-offset-2 columns">
			<div class="row">
			  <div class="large-12 columns">
				<h1>Alta de nueva remisi&oacute;n</h1>
			  </div>
			</div>
			
			<div class="row"><!-- validacion de folio -->
			  <div class="large-12 columns">
				<form id="formu">
					<div class="row">
						<div class="large-12 columns">
						  <label>Folio de autorizaci&oacute;n:
							<input type="text" id="folio_auto" placeholder="No. de folio" />
						  </label>
						</div>
					</div>
					<div class="row">
						<div class="large-12 columns">
						  <label>Folio progresivo:
							<input type="text" id="folio_prog" placeholder="No. de folio" />
						  </label>
						</div>
					</div>
					<!--div class="row">
						<div class="large-12 columns">
						  <label>Fecha de expedici&oacute;n de la remisi&oacute;n:
							<input type="text" id="fecha_expedicion" placeholder="Fecha de expedici&oacute;n" />
						  </label>
						</div>
					</div-->
					<div class="row">
						<div class="large-12 columns">
						  <label>Transporte encargado:				
							<select id="transporte">
							   <option value="0">Selecciona</option>
							</select>
						  </label>
						</div>
					</div>
					<div class="row">
						<div class="large-12 columns">
						  <label>CAT destino:				
							<select  id="cat">
							   <option value="0">Selecciona</option>
							</select>
						  </label>
						</div>
					</div>
					<div class="row">
						<div class="large-12 columns">
							<label>Observaciones:
								<textarea id="observaciones" placeholder="Observaciones de la operaci&oacute;n"></textarea>
							</label>
						</div>
					</div>
					<div class="row">
						<div class="large-12 columns">
						  <label>Saldo disponible:
							<input type="text" id="saldo_disponible" placeholder="Saldo disponible" />
						  </label>
						</div>
					</div>
					<div class="row">
						<div class="large-12 columns">
						  <label>Saldo restante:
							<input type="text" id="saldo_restante" placeholder="Saldo restante" />
						  </label>
						</div>
					</div>
					<div class="row">
						<div class="large-12 columns">
						  <label>Cantidad que ampara el documento:
							<input type="text" id="cantidad_amparada" placeholder="Cantidad" />
						  </label>
						</div>
					</div>
					<div class="row">
						<div class="large-12 columns">
						  <label>Volumen o peso amparado:
							<input type="text" id="volumen_peso" placeholder="Valor" />
						  </label>
						</div>
					</div>
					<div class="row">
						<div class="large-12 columns">
						  <label>Unidades (kilogramos / metros c&uacute;bicos):
							<select  id="unidades">
							   <option value="0">Selecciona</option>
							   <option value="m3">Metros c&uacute;bicos</option>
							   <option value="kg">Kilogramos</option>
							</select>
						  </label>
						</div>
					</div>
					<div class="row">
						<div class="large-12 columns text-center "> 
							<div id="mensaje_validar"></div>
							<a href="#" id="enviar" class="button radius">Enviar</a>
						</div>
					</div>
				</form> 
			  </div>
			</div>
	</div>
	</div>
	<div class="row footer">
	  <div class="small-12 columns">
		<p>Blvd. Adolfo Ruiz Cortines # 4209 Col. Jardines de la Monta&ntilde;a, Deleg. Tlalpan</p>
		<p>Distrito Federal CP. 14210, Tel. (55) 5490-0900</p>
	  </div>
	  
	</div>
    
    <script src="../js/vendor/jquery.js"></script>
	<script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.4.0.min.js"></script> 
    <script src="../js/foundation.min.js"></script>
    <script>
		// inicialización de parse y foundation
		$(document).foundation();
		Parse.initialize("xJPG4xeiwqTF0RKZgHboZDTzl2aWn7lDBTM8iZQh", "Jmvrl7iprcqLFyeoptiorcg5ISdlrSTlAOuoIoyF");
		$("#enviar").click(function(){
			enviaForm();
		});
		$(document).ready(function(){
			// nos volvemos usuario guardado
			currentUser = Parse.User.current(); // usuario antes de levantar al otro...
            if (currentUser) {
                // * averiguamos cual es el titular actual	
                titular = 0;
                transportistas = new Object();
                cats = new Object();

                

                var Titular = Parse.Object.extend("Titular");
                var query = new Parse.Query(Titular);
                query.equalTo("Usuario", currentUser);
                query.first({
                  success: function(tit) {
                    // Successfully retrieved the object.
                    titular = tit;
                    //$("#idtitular").val(tit.id); // para evitar problemas
                    var html = '<option value="0">Selecciona</option> \n'; // selecciona
                    var Transportistas = Parse.Object.extend("Transportistas");
                    var query = new Parse.Query(Transportistas);
                    // los asociados al titular
                    query.equalTo("Titular", tit);
                    // Sorts the results in ascending order by the score field
                    query.ascending("Propietario");
                    query.find({
                      success: function(results) {
                        console.log("Trans: Successfully retrieved " + results.length + " scores.");
                        // Do something with the returned Parse.Object values
                        for (var i = 0; i < results.length; i++) { 
                          var object = results[i];
                          //console.log(object.id + ' - ' + object.get('Nombre'));
                          transportistas[object.id] = object;
                          html = html + '<option value="' + object.id + 
                                        '">' + object.get('Propietario') + '</option> \n'; // para ciclo
                        }
                        //console.log(html);
                        $("#transporte").html(html); // cargamos nuevos titulares
                        cargaCAT();
                      },
                      error: function(error) {
                        console.log("Trans: Error: " + error.code + " " + error.message);
                      }
                    });
                    console.log("titular traido, nombre:" + tit.get("Nombre"));
                },
                  error: function(error) {
                    console.log("Titular Error: " + error.code + " " + error.message);
                  }
                });

            } else {
                // show the signup or login page
				console.log("no login info");
				window.location.assign("../index.html");
            }
			
		});
		///console.log(Parse.User.id + ' parse user id');
		// carga los titulares para los transportistas
		function cargaCAT(){
			
			var html = '<option value="0">Selecciona</option> \n'; // selecciona
			var CAT = Parse.Object.extend("CAT");
			var query = new Parse.Query(CAT);
			// Sorts the results in ascending order by the score field
			query.ascending("Nombre");
			query.find({
			  success: function(results) {
				console.log("CAT Successfully retrieved " + results.length + " scores.");
				// Do something with the returned Parse.Object values
				for (var i = 0; i < results.length; i++) { 
				  var object = results[i];
				  cats[object.id] = object;
				  //console.log(object.id + ' - ' + object.get('Nombre'));
				  html = html + '<option value="' + object.id + 
								'">' + object.get('Nombre') + '</option> \n'; // para ciclo
				}
				//console.log(html);
				$("#cat").html(html); // cargamos nuevos titulares
			  },
			  error: function(error) {
				console.log("Error: " + error.code + " " + error.message);
			  }
			});
			
			
		}
		
		function alertError(msg){
			var espacio = $("#mensaje_validar");
			// no pasa validacion
			var html = '<div data-alert class="alert-box dos  alert radius">'+
				msg + '<a href="#" class="close">&times;</a></div>';
			//var espacio = $("#mensaje");
			espacio.addClass("hide");
			var html1 = espacio.html();
			espacio.html(html1 + html);
			espacio.show("slow");
			$(document).foundation();
		}
		function alertSuccess(msg){
			var espacio = $("#mensaje_validar");
			// no pasa validacion
			var html = '<div data-alert class="alert-box dos  success radius">'+
				msg + '<a href="#" class="close">&times;</a></div>';
			//var espacio = $("#mensaje");
			espacio.addClass("hide");
			var html1 = espacio.html();
			espacio.html(html1 + html);
			espacio.show("slow");
			$(document).foundation();
		}
		
		function enviaForm(){
			// leemos obj cat trans titular
			// enviamos
			console.log("envimaos form ***");
			//console.log($("#folio_auto").val());
			//console.log($("#folio_prog").val());
			//console.log($("#transporte").val());
			//console.log($("#cat").val());
			//console.log($("#observaciones").val());
			//console.log($("#saldo_disponible").val());
			//console.log($("#saldo_restante").val());
			//console.log($("#cantidad_amparada").val());
			//console.log($("#volumen_peso").val());
			//console.log($("#unidades").val());
			//console.log("**** envimaos form");
			
			var cat = $("#cat").val();
			var transporte = $("#transporte").val();
			
			if(cat == 0 || transporte == 0){
				alertError("Los valores de CAT y Transportista son muy importantes, por favor verif&iacute;calos.");
				return false;
			}
			
			var Documentos = Parse.Object.extend("Documentos");
			var doc = new Documentos();
			var d = new Date();
			var d2 = new Date();
			d2.setDate(d.getDate() + 3)
			doc.save({
			  CAT: cats[$("#cat").val()],
			  Transportista: transportistas[$("#transporte").val()],
			  Titular: titular,
			  Fecha_exp:  d,
			  Fecha_ven: d2,
			  Folio_auto: $("#folio_auto").val(),
			  Folio_prog: parseInt($("#folio_prog").val()),
			  Observaciones: $("#observaciones").val(),
			  Remitente_tipo: "Titular",
			  Tipo: "Remision",
			  Cantidad: $("#cantidad_amparada").val(),
			  Volumen_peso: $("#volumen_peso").val(),
			  Unidades: $("#unidades").val(),
			  Saldo_restante: $("#saldo_restante").val(),
			  Saldo_disponible: $("#saldo_disponible").val(),
			}, {
			  success: function(doc) {
				console.log("documento guardado");
				$("#formu")[0].reset();
				alertSuccess("Documento guardado correctamente");
			  },
			  error: function(doc, error) {
				console.log("Error al salvar el documento");
				console.log(error);
			  }
			});
			
		}
    </script>
  </body>
</html>
